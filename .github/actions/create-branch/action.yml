name: Create branch from issue

inputs:
  branch-prefix:
    description: 'Branch prefix (e.g., issue, feat, fix)'
    required: true
    default: 'issue'

outputs:
  branch-name:
    description: 'Created branch name'
    value: ${{ steps.create-branch.outputs.branch-name }}

runs:
  using: composite
  steps:
    - name: Create branch from develop
      id: create-branch
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.payload.issue.number;
          const baseBranch = 'develop';
          const prefix = '${{ inputs.branch-prefix }}';
          const targetBranch = `${prefix}/${issueNumber}`;
          const owner = context.repo.owner;
          const repo = context.repo.repo;

          // develop ë¸Œëœì¹˜ì—ì„œ ì»¤ë°‹ SHA ê°€ì ¸ì˜¤ê¸°
          console.log(`ğŸ” Getting commit SHA for ${baseBranch} branch`);
          const base = await github.rest.repos.getBranch({
            owner,
            repo,
            branch: baseBranch,
          });
          const baseSha = base.data.commit.sha;

          // ë¸Œëœì¹˜ ìƒì„±
          console.log(`ğŸ“ Creating branch ${targetBranch}`);
          try {
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${targetBranch}`,
              sha: baseSha,
            });
          } catch (err) {
            if (err.status === 422) {
              console.log('âš ï¸ Branch already exists. Skipping.');
            } else {
              throw err;
            }
          }

          // develop ì»¤ë°‹ì˜ íŠ¸ë¦¬ SHA ê°€ì ¸ì˜¤ê¸°
          console.log(`ğŸ” Getting tree SHA for ${baseBranch} branch`);
          const baseCommit = await github.rest.git.getCommit({
            owner,
            repo,
            commit_sha: baseSha,
          });
          const treeSha = baseCommit.data.tree.sha;

          // ë¹ˆ ì»¤ë°‹ ìƒì„±
          console.log(`ğŸ“ Creating empty commit for ${targetBranch}`);
          const emptyCommit = await github.rest.git.createCommit({
            owner,
            repo,
            message: `Created branch for issue #${issueNumber}\n\n[skip ci]`,
            tree: treeSha,
            parents: [baseSha],
          });

          // ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸
          console.log(`ğŸ”„ Updating branch ${targetBranch}`);
          await github.rest.git.updateRef({
            owner,
            repo,
            ref: `heads/${targetBranch}`,
            sha: emptyCommit.data.sha,
            force: false,
          });

          console.log(`âœ… Created branch ${targetBranch}`);
          
          // ë¸Œëœì¹˜ ì´ë¦„ì„ ì¶œë ¥ìœ¼ë¡œ ì„¤ì •
          core.setOutput('branch-name', targetBranch);
